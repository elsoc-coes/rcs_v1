
# Transformaciones políticas


```{r cargar-paquetes-3}
rm(list=ls())
 
library(knitr)
library(tidyverse)
library(sjmisc)
library(sjlabelled)
library(ggrepel)
library(ggalluvial)
library(survey)
library(elsoc)
library(lubridate)
library(viridis)
library(statar)
library(tidyverse)
```

```{r cargar-datos-3}

load(file.path('..', 'inputs', 'ELSOC_Long_2016_2022_v1.00_R.RData'))
load(file.path('..', 'inputs', 'ELSOC_Wide_2016_2022_v1.00_R.RData'))

elsoc_long.0 <- elsoc_long_2016_2022
elsoc_long_2016_2022 <- elsoc_long.0 %>%
  mutate(pleb = case_when(c55 == 4 ~ 5,
                          c55 == 1 ~ 1,
                          c55 == 2 ~ 2,
                          c55 == 3 ~ 3,
                          c55 == -999 ~ 5,
                          c55 == -888 ~ 5,
                          c55 == -777 ~ 5,
                          c55 == -666 ~ 5,
                          c56 == -999 ~ 5,
                          c56 == -888 ~ 5,
                          c56 == -777 ~ 5,
                          c56 == -666 ~ 5,
                          c56 == 2 ~ 4,
                          c57 == 1 ~ 1,
                          c57 == 2 ~ 2,
                          c57 == 3 ~ 3,
                          c57 == -999 ~ 5,
                          c57 == -888 ~ 5,
                          c57 == -777 ~ 5,
                          c57 == -666 ~ 5))  %>%  
  group_by(idencuesta) %>%
  mutate(salida = ifelse(length(na.omit(pleb)) == 0, NA, max(pleb, na.rm = T))) %>%
  ungroup()

load(file.path('..', 'inputs', 'perfiles.RData'))

elsoc_long_2016_2022 <- elsoc_long_2016_2022 %>%
  left_join(perfiles, by = "idencuesta") %>%
   mutate(pp_3 = factor(pp_3, 
                       levels = 1:3,
                       labels = c("Votante Habitual (70.21%)", "No-Votante (17.06%)", "Indefinido (12.73%)"))) %>%
   mutate(pp_4 = factor(pp_4, 
                       levels = 1:4,
                       labels = c("1 (10.90%)", "2 (8.29%)", " 3 (69.28%)", "4 (11.53%)"))) %>%
   mutate(pp_5 = factor(pp_5, 
                       levels = 1:5,
                       labels = c("1 (10.90%)", "2 (10.78%)", "3 (57.75%)", 
                                  "4 (5.34%)", "5 (15.24%)")))

elsoc_wide_2016_2022 <- elsoc_wide_2016_2022 %>%
  left_join(perfiles, by = "idencuesta") %>%
   mutate(pp_3 = factor(pp_3, 
                       levels = 1:3,
                       labels = c("Votante\nHabitual (70.21%)", "No-Votante (17.06%)", "Indefinido (12.73%)"))) %>%
   mutate(pp_4 = factor(pp_4, 
                       levels = 1:4,
                       labels = c("1 (10.90%)", "2 (8.29%)", " 3 (69.28%)", "4 (11.53%)"))) %>%
   mutate(pp_5 = factor(pp_5, 
                       levels = 1:5,
                       labels = c("1 (10.90%)", "2 (10.78%)", "3 (57.75%)", 
                                  "4 (5.34%)", "5 (15.24%)")))

```

## Participación electoral

```{r graf-participacion}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5,6) &
           !is_nsnr(c11, c43, c50, c52, c54, c56)) %>% 
  prop_list(c11 == 1, c43 == 1, c50 == 1, c52 == 1, c54 == 1, c56 == 1,
            by = ola, na.rm = T) %>%
  mutate(ola = paste(name, ola)) %>%
  mutate(ola = case_when(ola == 'c11 == 1 1' ~ 1,
                          ola == 'c11 == 1 3' ~ 2,
                          ola == 'c43 == 1 5' ~ 3,
                          ola == 'c54 == 1 6' ~ 4,
                          ola == 'c50 == 1 6' ~ 5,
                          ola == 'c52 == 1 6' ~ 6,
                          ola == 'c56 == 1 6' ~ 7)) %>%
  mutate(ola = factor(ola, 
                      levels = 1:7, 
                      labels = c('Elecciones\nPresidenciales\nde 2013', 
                                 'Elecciones\nPresidenciales\nde 2017', 
                                 'Plebiscito de\nEntrada\n2020',
                                 'Convención y\nMunicipales\nde 2021',
                                 'Elecciones\nPresidenciales\nde 2021\n(1° vuelta)',
                                 'Elecciones\nPresidenciales\nde 2021\n(2° vuelta)',
                                 'Plebiscito\nSalida\n2022'))) %>% 
  ggplot(aes(y = prop, x = ola, group = 1,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_point(size = 1.75) +
  geom_line() +
  geom_text_repel(size = 3, nudge_y = .02) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Participación electoral por elección',
          subtitle = 'Porcentaje que votó en...')

```

```{r graf-perfiles-3}

tab2 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 3) %>%
  filter(!is.na(c11), !is.na(pp_3)) %>%
  mutate(c11 = factor(car::recode(c11, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c11, by = pp_3, na.rm = T) %>% 
  rename(Participa = c11) %>% 
  mutate(var = 2) 

tab3 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 5) %>%
  filter(!is.na(c43), !is.na(pp_3)) %>%
  mutate(c43 = factor(car::recode(c43, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c43, by = pp_3, na.rm = T) %>% 
  rename(Participa = c43) %>% 
  mutate(var = 3) 

tab4 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c54), !is.na(pp_3)) %>%
  mutate(c54 = factor(car::recode(c54, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c54, by = pp_3, na.rm = T) %>% 
  rename(Participa = c54) %>% 
  mutate(var = 4) 

tab5 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c50), !is.na(pp_3)) %>%
  mutate(c50 = factor(car::recode(c50, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c50, by = pp_3, na.rm = T) %>% 
  rename(Participa = c50) %>% 
  mutate(var = 5) 

tab6 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c52), !is.na(pp_3)) %>%
  mutate(c52 = factor(car::recode(c52, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c52, by = pp_3, na.rm = T) %>% 
  rename(Participa = c52) %>% 
  mutate(var = 6)

tab <- rbind(tab2, tab3, tab4, tab5, tab6) %>%
  mutate(var = factor(var, levels = 2:6,
                        labels = c("Elecciones\nPresidenciales de 2017",
                                   "Plebiscito de\nEntrada 2020",
                                   "Convención y Municipales\nde 2021",
                                   "Elecciones Presidenciales\nde 2021 (1° vuelta)",
                                   "Elecciones Presidenciales\nde 2021 (2° vuelta)")))
rm(tab2, tab3, tab4, tab5, tab6)

tab %>% 
  ggplot(aes(x = prop, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  facet_grid(~ pp_3) +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  scale_fill_viridis_d(begin = 0, end = .8) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Perfiles de participación electoral',
          subtitle = 'Tres clases latentes')

```

```{r graf-perfiles-4}


tab2 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 3) %>%
  filter(!is.na(c11), !is.na(pp_4)) %>%
  mutate(c11 = factor(car::recode(c11, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c11, by = pp_4, na.rm = T) %>% 
  rename(Participa = c11) %>% 
  mutate(var = 2) 

tab3 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 5) %>%
  filter(!is.na(c43), !is.na(pp_4)) %>%
  mutate(c43 = factor(car::recode(c43, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c43, by = pp_4, na.rm = T) %>% 
  rename(Participa = c43) %>% 
  mutate(var = 3) 

tab4 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c54), !is.na(pp_4)) %>%
  mutate(c54 = factor(car::recode(c54, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c54, by = pp_4, na.rm = T) %>% 
  rename(Participa = c54) %>% 
  mutate(var = 4) 

tab5 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c50), !is.na(pp_4)) %>%
  mutate(c50 = factor(car::recode(c50, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c50, by = pp_4, na.rm = T) %>% 
  rename(Participa = c50) %>% 
  mutate(var = 5) 

tab6 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c52), !is.na(pp_4)) %>%
  mutate(c52 = factor(car::recode(c52, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c52, by = pp_4, na.rm = T) %>% 
  rename(Participa = c52) %>% 
  mutate(var = 6)

tab <- rbind(tab2, tab3, tab4, tab5, tab6) %>%
  mutate(var = factor(var, levels = 2:6,
                        labels = c("Elecciones\nPresidenciales de 2017",
                                   "Plebiscito de\nEntrada 2020",
                                   "Convención y Municipales\nde 2021",
                                   "Elecciones Presidenciales\nde 2021 (1° vuelta)",
                                   "Elecciones Presidenciales\nde 2021 (2° vuelta)")))
rm(tab2, tab3, tab4, tab5, tab6)

tab %>% 
  ggplot(aes(x = prop, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  facet_grid(~ pp_4) +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  scale_fill_viridis_d(begin = 0, end = .8) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Perfiles de participación electoral',
          subtitle = 'Cuatro clases latentes')

```

```{r graf-perfiles-5}


tab2 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 3) %>%
  filter(!is.na(c11), !is.na(pp_5)) %>%
  mutate(c11 = factor(car::recode(c11, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c11, by = pp_5, na.rm = T) %>% 
  rename(Participa = c11) %>% 
  mutate(var = 2) 

tab3 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 5) %>%
  filter(!is.na(c43), !is.na(pp_5)) %>%
  mutate(c43 = factor(car::recode(c43, "1 = 2; 2:3 = 1"),
                             levels = 1:2,
                             labels = c('No votó', 'Votó'))) %>%
  prop(c43, by = pp_5, na.rm = T) %>% 
  rename(Participa = c43) %>% 
  mutate(var = 3) 

tab4 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c54), !is.na(pp_5)) %>%
  mutate(c54 = factor(car::recode(c54, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c54, by = pp_5, na.rm = T) %>% 
  rename(Participa = c54) %>% 
  mutate(var = 4) 

tab5 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c50), !is.na(pp_5)) %>%
  mutate(c50 = factor(car::recode(c50, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c50, by = pp_5, na.rm = T) %>% 
  rename(Participa = c50) %>% 
  mutate(var = 5) 

tab6 <- elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>%
  filter(!is.na(c52), !is.na(pp_5)) %>%
  mutate(c52 = factor(car::recode(c52, "1 = 2; 2 = 1"),
                          levels = 1:2,
                          labels = c('No votó', 'Votó'))) %>%
  prop(c52, by = pp_5, na.rm = T) %>% 
  rename(Participa = c52) %>% 
  mutate(var = 6)

tab <- rbind(tab2, tab3, tab4, tab5, tab6) %>%
  mutate(var = factor(var, levels = 2:6,
                        labels = c("Elecciones\nPresidenciales de 2017",
                                   "Plebiscito de\nEntrada 2020",
                                   "Convención y Municipales\nde 2021",
                                   "Elecciones Presidenciales\nde 2021 (1° vuelta)",
                                   "Elecciones Presidenciales\nde 2021 (2° vuelta)")))
rm(tab2, tab3, tab4, tab5, tab6)

tab %>% 
  ggplot(aes(x = prop, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  facet_grid(~ pp_5) +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  scale_fill_viridis_d(begin = 0, end = .8) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Perfiles de participación electoral',
          subtitle = 'Cinco clases latentes')

```

```{r graf-tipo-participacion}

elsoc_long_2016_2022 %>% 
  filter(!is.na(pp_3)) %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5,6) &
           !is_nsnr(c11, c43, c50, c52, c54, c56)) %>% 
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop_list(c11 == 1, c43 == 1, c50 == 1, c52 == 1, c54 == 1, c56 == 1,
            by = c(ola, pp_3), na.rm = T) %>%
  mutate(ola = paste(name, ola)) %>%
  mutate(ola = case_when(ola == 'c11 == 1 1' ~ 1,
                          ola == 'c11 == 1 3' ~ 2,
                          ola == 'c43 == 1 5' ~ 3,
                          ola == 'c54 == 1 6' ~ 4,
                          ola == 'c50 == 1 6' ~ 5,
                          ola == 'c52 == 1 6' ~ 6,
                          ola == 'c56 == 1 6' ~ 7)) %>%
  mutate(ola = factor(ola, 
                      levels = 1:7, 
                      labels = c('Elecciones\nPresidenciales\nde 2013', 
                                 'Elecciones\nPresidenciales\nde 2017', 
                                 'Plebiscito de\nEntrada\n2020',
                                 'Convención y\nMunicipales\nde 2021',
                                 'Elecciones\nPresidenciales\nde 2021\n(1° vuelta)',
                                 'Elecciones\nPresidenciales\nde 2021\n(2° vuelta)',
                                 'Plebiscito\nSalida\n2022'))) %>% 
  ggplot(aes(y = prop, x = ola, group = pp_3, color = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_point(size = 1.75) +
  geom_line() +
  geom_text_repel(size = 3, nudge_y = .02) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Participación electoral por elección y perfil de participación',
          subtitle = 'Porcentaje que votó en...')

```

## Caracterización del tipo de votante

```{r graf-sexo-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(m0_sexo), !is.na(pp_3)) %>%   
  mutate(m0_sexo = factor(m0_sexo, 
                       levels = 1:2,
                       labels = c("Hombre", "Mujer"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(m0_sexo, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(m0_sexo), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Sexo según tipo de votante')

```

```{r graf-edad-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(m0_edad), !is.na(pp_3)) %>%
  mutate(m0_edad = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                       levels = 1:4,
                       labels = c("18-29", "30-49", "50-64", "65 o +"))) %>%
   mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(m0_edad, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(m0_edad), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Tramos etarios según tipo de votante')

```

```{r graf-educacion-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(m01), !is.na(pp_3)) %>%
  mutate(m01 = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                   levels = 1:4,
                   labels = c("Básica", "Media", "Técnica", "Universitaria"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(m01, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(m01), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Nivel educacional según tipo de votante')

```

```{r graf-laboral}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(m02), !is.na(pp_3)) %>%
  mutate(sit_laboral = factor(car::recode(m02, "1:3 = 1; 6 = 2; c(4,5,7,8,9) = 3"),
                              levels = 1:3,
                              labels = c('Ocupados',
                                  'Desocupados',
                                  'Inactivos'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(sit_laboral, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(sit_laboral), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Situación laboral según tipo de votante')

```

```{r graf-clase}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(c33), !is.na(pp_3)) %>%
  mutate(c33 = factor(car::recode(c33, recodes = "1:2 = 1; 3 = 2; 3:4 = 3"),
                   levels = 1:3,
                   labels = c("Baja o\nMedia-baja", "Media", "Alta o\nMedia-alta"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(c33, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(c33), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Clase social subjetiva según tipo de votante')

```


```{r graf-quintil}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1, !is.na(pp_3)) %>%
  mutate(
  m30 = as.numeric(car::recode(m30, "1 = 110000; 2 = 251000; 3 = 305000; 4 = 355000; 5 = 400000; 
  6 = 445000; 7 = 490000; 8 = 535000; 9 = 585000; 10 = 640000; 
  11 = 700000; 12 = 765000; 13 = 845000; 14 = 935000; 15 = 1040000;
  16 = 1180000; 17 = 1375000; 18 = 1670000; 19 = 2275000; 20 = 2700000; -666:-999 = NA; NA = NA")),
  m30b = as.numeric(car::recode(m30b, "1 = 170000; 2 = 300000; 3 = 400000; 4 = 600000; 
                                5 = 1200000; -666:-999 = NA; NA = NA")),
  m29_imp = case_when(is_nsnr(m29) & !is.na(m30) ~ m30,
                      is_nsnr(m29) & !is.na(m30b) ~ m30b,
                      TRUE ~ m29),
  nhogar = case_when(ola == 1 ~ nhogar1,
                     ola == 2 ~ m46_nhogar,
                     TRUE ~ m54),
  nhogar = ifelse(is_nsnr(nhogar), NA, nhogar)) %>% 
  group_by(idencuesta) %>% 
  mutate(nhogar = ifelse(is.na(nhogar), lag(nhogar), nhogar)) %>% 
  ungroup() %>% 
  mutate(ypc = m29_imp / nhogar) %>% 
  group_by(ola) %>% 
  mutate(quintil = xtile(ypc, n = 5, wt = ponderador02),
         quintil = factor(quintil, levels = 1:5, labels = glue::glue('Quintil {1:5}'))
         ) %>%
  ungroup() %>% 
  mutate(pp_3 = factor(pp_3, labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(quintil, by = c(pp_3, ola), na.rm = TRUE) %>% 
  filter(ola == 6) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(quintil), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'black', 'white', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Quintiles de ingreso, según tipo de votante')

```

Clase social según deciles de ingreso: deciles 1-4 = Clase baja, deciles 5-9 = Clase media, decil 10 = clase alta.

```{r graf-clase-ingreso}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1, !is.na(pp_3)) %>%
  mutate(
  m30 = as.numeric(car::recode(m30, "1 = 110000; 2 = 251000; 3 = 305000; 4 = 355000; 5 = 400000; 
  6 = 445000; 7 = 490000; 8 = 535000; 9 = 585000; 10 = 640000; 
  11 = 700000; 12 = 765000; 13 = 845000; 14 = 935000; 15 = 1040000;
  16 = 1180000; 17 = 1375000; 18 = 1670000; 19 = 2275000; 20 = 2700000; -666:-999 = NA; NA = NA")),
  m30b = as.numeric(car::recode(m30b, "1 = 170000; 2 = 300000; 3 = 400000; 4 = 600000; 
                                5 = 1200000; -666:-999 = NA; NA = NA")),
  m29_imp = case_when(is_nsnr(m29) & !is.na(m30) ~ m30,
                      is_nsnr(m29) & !is.na(m30b) ~ m30b,
                      TRUE ~ m29),
  nhogar = case_when(ola == 1 ~ nhogar1,
                     ola == 2 ~ m46_nhogar,
                     TRUE ~ m54),
  nhogar = ifelse(is_nsnr(nhogar), NA, nhogar)) %>% 
  group_by(idencuesta) %>% 
  mutate(nhogar = ifelse(is.na(nhogar), lag(nhogar), nhogar)) %>% 
  ungroup() %>% 
  mutate(ypc = m29_imp / nhogar) %>% 
  group_by(ola) %>% 
  mutate(decil = xtile(ypc, n = 10, wt = ponderador02),
         clase_ingreso = factor(car::recode(decil, "1:4 = 1; 5:9 = 2; 10 = 3"),
                                levels = 1:3,
                                labels = c('Clase baja', 'Clase media', 'Clase alta'))
         ) %>%
  ungroup() %>% 
  mutate(pp_3 = factor(pp_3, labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(clase_ingreso, by = c(pp_3, ola), na.rm = TRUE) %>% 
  filter(ola == 6) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(clase_ingreso), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Clase social por ingreso, según tipo de votante')

```

## Proceso constituyente

```{r graf-pleb-salida}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  filter(ola == 6) %>%
    mutate(salida = factor(salida, 
                       levels = 1:5,
                       labels = c("Apruebo", "Rechazo", "Nulo/Blanco",
                                        "No vota", "NS/NR"))) %>% 
  prop(salida, na.rm = T) %>%
  ggplot(aes(y = prop, x = salida, label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Plebiscito de Salida 2022',
          subtitle = 'Porcentaje que votó...')
  
```

```{r graf-alluvial-pleb}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1, ola %in% 5:6) %>% 
  mutate(salida = factor(car::recode(salida, "1 = 1; 2 = 2; 3:5 = 3"))) %>%
  mutate(c44 = case_when(c44 == 1 ~ 1,
                            c44 == 2 ~ 2,
                            c44 == 3 ~ 3,
                            c44 == 4 ~ 3,
                            c44 == -999 ~ 3,
                            c44 == -888 ~ 3,
                            c44 == -777 ~ 3,
                            c44 == -666 ~ 3,
                            c43 == 2 ~ 3,
                            c43 == 3 ~ 3,
                            c43 == -999 ~ 3,
                            c43 == -888 ~ 3,
                            c43 == -777 ~ 3,
                            c43 == -666 ~ 3))  %>%
   mutate(pos_id = ifelse(!is.na(c44), c44, salida),
          pos_id = factor(pos_id,
                             levels = 1:3,
                             labels = c("Apruebo", "Rechazo", "Otros")),
             ola = factor(ola,
                          levels = 5:6,
                          labels = c("Plebiscito de\nEntrada\n2020",
                                     "Plebiscito de\nSalida\n2022"))) %>%
  survey_design_elsoc() %>%
  svytable(~ pos_id + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(Freq > 0) %>%
  ggplot(aes(y = prop, x = ola, fill = fct_rev(pos_id), 
             stratum = fct_rev(pos_id), alluvium = idencuesta)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, begin = 0, end = .8, option = 'viridis') +
  geom_text(data = function(x) { group_by(.data = x, ola, pos_id) %>%
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>%
      ungroup()},
            aes(label = scales::percent(prop, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 3,
            color = c('white', 'black', 'black', 
      'white', 'black', 'black')) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Intención de voto en plebiscito de entrada y salida')

```

```{r graf-tipo-salida}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>% 
  filter(ola == 6) %>% 
  filter(!is.na(salida), !is.na(pp_3)) %>%
  mutate(salida = factor(car::recode(salida, "1 = 1; 2 = 2; 3:5 = 3"), 
                       levels = 1:3,
                       labels = c("Apruebo", "Rechazo", "Otros"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(salida, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(salida), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Voto en plebiscito de salida según tipo de votante')

```

```{r graf-alluvial-pleb-tipo}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1, ola %in% 5:6, , !is.na(pp_3)) %>% 
  mutate(salida = factor(car::recode(salida, "1 = 1; 2 = 2; 3:5 = 3"))) %>%
  mutate(c44 = case_when(c44 == 1 ~ 1,
                            c44 == 2 ~ 2,
                            c44 == 3 ~ 3,
                            c44 == 4 ~ 3,
                            c44 == -999 ~ 3,
                            c44 == -888 ~ 3,
                            c44 == -777 ~ 3,
                            c44 == -666 ~ 3,
                            c43 == 2 ~ 3,
                            c43 == 3 ~ 3,
                            c43 == -999 ~ 3,
                            c43 == -888 ~ 3,
                            c43 == -777 ~ 3,
                            c43 == -666 ~ 3))  %>%
   mutate(pos_id = ifelse(!is.na(c44), c44, salida),
          pos_id = factor(pos_id,
                             levels = 1:3,
                             labels = c("Apruebo", "Rechazo", "Otros")),
             ola = factor(ola,
                          levels = 5:6,
                          labels = c("Plebiscito de\nEntrada\n2020",
                                     "Plebiscito de\nSalida\n2022"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  survey_design_elsoc() %>%
  svytable(~ pos_id + ola + idencuesta + pp_3, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola, pp_3) %>% 
  mutate(prop = Freq/sum(Freq, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(Freq > 0) %>%
  ggplot(aes(y = prop, x = ola, fill = fct_rev(pos_id), 
             stratum = fct_rev(pos_id), alluvium = idencuesta)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ pp_3) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, begin = 0, end = .8, option = 'viridis') +
  geom_text(data = function(x) { group_by(.data = x, ola, pos_id, pp_3) %>%
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>%
      ungroup()},
            aes(label = scales::percent(prop, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 3,
            color = c('white', 'black', 'black',
                             'white', 'black', 'black',
                             'white', 'white', 'black',
                             'white', 'black', 'black',
                             'white', 'black', 'black',
                             'white', 'black', 'black')) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Intención de voto en plebiscito de entrada y salida')

```

```{r graf-consti-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c28), !is.na(pp_3)) %>%  
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c28 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Nueva constitución según tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo con cambiar la constitución')

```

```{r graf-convencion-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5,6) &
           !is_nsnr(c05_14, pp_3), !is.na(pp_3)) %>% 
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop_list(c05_14 %in% 4:5, by = pp_3, na.rm = T) %>%
  ggplot(aes(y = prop, x = pp_3, label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Confianza en la Convención Constitucional según tipo de votante',
          subtitle = 'Bastante o mucha confianza')

```

## Actitudes hacia la democracia

```{r graf-leg-dem-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c25), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c25 == 1, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .025, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Legitimidad democrática, según tipo de votante',
          subtitle = 'Porcentaje que prefiere la democracia a cualquier otra forma de gobierno')


```

```{r graf-satis-dem-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c01), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c01 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .0, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.2)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Satisfacción democrática, según tipo de votante',
          subtitle = 'Bastante o muy satisfecho')


```

```{r graf-autoritarismo-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c18_04), !is.na(c18_05), !is.na(c18_06), !is.na(c18_07), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
    rowwise() %>% 
  mutate(autoritarismo = mean(c18_04, c18_05, c18_06, c18_07, na.rm = TRUE)) %>% 
  prop(autoritarismo %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .0, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Actitudes autoritarias, según tipo de votante',
          subtitle = 'Bastante o muy autoritario en promedio')


```

## Identidad e involucramiento político

```{r graf-posicion-pol-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  filter(ola == 6) %>% 
  filter(!is.na(c15), !is.na(pp_3)) %>%
  mutate(c15 = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11 = 4; 12 = 5"), 
                       levels = 1:5,
                       labels = c("Izquierda", "Centro", "Derecha",
                                  "Independiente", "Ninguna"))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(c15, by = pp_3, na.rm = TRUE) %>% 
  ggplot(aes(x = prop, y = fct_rev(pp_3), fill = fct_rev(c15), 
             label = scales::percent(prop, .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL, title = NULL, fill = NULL) +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), size = 3,
            color = rep(c('black', 'black', 'white', 'white', 'white'), 3)) +
  theme_bw() + 
  scale_fill_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Posición política 2022, según tipo de votante',
          subtitle = 'Autoposicionamiento político en la escala izquierda-derecha')

```

```{r graf-centro-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c15), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c15 == 5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Posición política de centro, según tipo de votante',
          subtitle = 'Porcentaje que se autoidentifica de centro')


```

```{r graf-sin-posicion-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c15), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c15 %in% 11:12, by = c(pp_3, ola), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Ausencia de posición política, según tipo de votante',
          subtitle = 'Porcentaje que no se autoidentifica en la escala izquierda-derecha')


```

```{r graf-cambios-idpolitica-ola}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c15), !is.na(pp_3)) %>%
  mutate(c15 = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica"))) %>%   mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  group_by(idencuesta) %>% 
  mutate(cambia = c15 != lag(c15),
         ola = factor(ola,
                      levels = 1:6,
                      labels = c('', '2016-2017', '2017-2018', '2018-2019', '2019-2021', '2021-2022'))) %>% 
  ungroup() %>% 
  prop(cambia == TRUE, by = c(pp_3, ola), na.rm = TRUE) %>% 
   ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .0, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.7)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Cambios en posición política, según tipo de votante',
          subtitle = 'Porcentaje que cambia su posición política entre olas')

```

```{r graf-interes-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c13), !is.na(pp_3)) %>%
  prop(c13 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .015, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,0.4)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Interés en la política, según tipo de votante',
          subtitle = 'Bastante o muy interesado')

```

```{r graf-id-partido-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c16), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(c16 == 15, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .015, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Partidismo, según tipo de votante',
          subtitle = 'Porcentaje que no se identifica con ningún partido político')

```

```{r graf-involv-poli-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c14_01), !is.na(c14_02), !is.na(c08_04), !is.na(pp_3)) %>%
  dplyr::select(c14_01, c14_02, c08_04, ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(c14_01, c14_02, c08_04)) %>% 
  mutate(name = factor(name,
                       levels = c('c14_01', 'c14_02', 'c08_04'),
                       labels = c('Habla de politica\ncon familiares o amigos',
                                  'Se informa sobre politica\nen medios de comunicacion',
                                  'Usa redes sociales para\nopinar en temas publicos'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .75)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Involucramiento político, según tipo de votante',
          subtitle = 'Frecuente o muy frecuentemente' )


```

## Confianza institucional

```{r graf-conf-pol-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c05_01), !is.na(c05_08), !is.na(pp_3)) %>%
  dplyr::select(c05_01, c05_08, ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(c05_01, c05_08)) %>% 
  mutate(name = factor(name,
                       levels = c('c05_01', 'c05_08'),
                       labels = c('Gobierno',
                                  'Presidente'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .25)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Confianza en instituciones políticas, según tipo de votante',
          subtitle = 'Bastante o mucha confianza' )

```

```{r graf-conf-pol-2-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c05_02), !is.na(c05_07), !is.na(pp_3)) %>%
  dplyr::select(c05_02, c05_07, ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(c05_02, c05_07)) %>% 
  mutate(name = factor(name,
                       levels = c('c05_02', 'c05_07'),
                       labels = c('Partidos políticos',
                                  'Congreso'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .06)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .002) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Confianza en instituciones políticas, según tipo de votante',
          subtitle = 'Bastante o mucha confianza' )

```

```{r graf-carab}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c05_03), !is.na(pp_3)) %>%
  prop(c05_03 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .0, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Confianza en Carabineros, según tipo de votante',
          subtitle = 'Bastante o mucha confianza')

```

## Movilización social

```{r graf-mov-tipo-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c20), !is.na(pp_3)) %>%
  mutate(movsoc = car::recode(c20, "1:5 = 1; 8:10 = 1; 6:7 = 2; 11:12 = 3"),
       movsoc = factor(movsoc, levels = 1:3,
                       labels = c('Mov. sociales progresistas', 'Mov. sociales conservadores', 'Ninguno'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(movsoc, by = c(pp_3, ola), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ movsoc) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Valoración de movimientos sociales, según tipo de votante',
          subtitle = 'Tipo de movimiento social más valorado' )

```

```{r graf-parti-mov-2}

elsoc_long_2016_2022 %>%
  filter(tipo_atricion == 1) %>% 
  as_label(ola) %>%
  filter(!is.na(c08_02), !is.na(pp_3)) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(c08_02 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,0.15)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Participación en marchas o manifestaciones, según tipo de votante',
          subtitle = 'Frecuente o muy frecuentemente')

```

## Opinión pública y contingencia

```{r graf-op-valores-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c37_01), !is.na(c37_02), !is.na(pp_3)) %>%
  dplyr::select(c37_01, c37_02,  ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(c37_01, c37_02)) %>% 
  mutate(name = factor(name,
                       levels = c('c37_01', 'c37_02'),
                       labels = c('Las parejas homosexuales deberían\npoder adoptar hijos',
                                  'El aborto debe ser legal bajo\ncualquier circunstancia'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Actitudes valóricas, según tipo de votante',
          subtitle = 'De acuerdo o totalmente de acuerdo' )


```

```{r graf-op-contingente-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(c37_04), !is.na(c37_05), !is.na(pp_3)) %>%
  dplyr::select(c37_04, c37_05,  ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(c37_04, c37_05)) %>% 
  mutate(name = factor(name,
                       levels = c('c37_04', 'c37_05'),
                       labels = c('Cada persona debiera asegurarse\npor si mismo su futura pensión\npara la tercera edad',
                                  'Chile debería tomar medidas más\ndrásticas para impedir el ingreso\nde inmigrantes al país'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Opinón pública sobre temas contingentes, según tipo de votante',
          subtitle = 'De acuerdo o totalmente de acuerdo' )


```

```{r desconf-mapuche}

elsoc_long_2016_2022 %>%
  sjlabelled::as_label(ola) %>%
  filter(!is.na(c06_05), tipo_atricion == 1) %>%  
  filter(!is.na(pp_3)) %>% 
  prop(c06_05 %in% 1:2, by = c(ola, pp_3), na.rm = T)  %>%
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Desconfianza hacia los Mapuche, según tipo de votante',
          subtitle = 'Nada o poca confianza')
  
```

```{r consti-mapuche}

elsoc_long_2016_2022 %>%
  sjlabelled::as_label(ola) %>%
  filter(!is.na(c46_05), tipo_atricion == 1) %>%  
  filter(!is.na(pp_3)) %>% 
  mutate(zona = factor(case_when(region_cod %in% c(1:4, 15) ~ 1,
                                 region_cod %in% c(5:8, 16) ~ 2, 
                                 region_cod %in% c(9:12, 14) ~ 3,
                                 region_cod == 13 ~ 4),
                       levels = 1:4,
                       labels = c('Norte', 'Centro', 'Sur', 'Metropolitana'))) %>%
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop_list(c46_05 %in% 4:5, by = c(zona, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = zona, fill = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  geom_text(position = position_dodge(.9), 
            vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .8, direction = 1, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('"La nueva constitución permitirá una mejor relación entre el Estado y los pueblos\nindígenas en Chile" (2022), según tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo')
  
```

```{r desconf-inmigrante}

elsoc_long_2016_2022 %>%
  filter(!is.na(r16), tipo_atricion == 1, ola %in% 4:6) %>%  
  filter(!is.na(pp_3)) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>%
  prop(r16 %in% 1:2, by = c(ola, cuestion_mig, pp_3), na.rm = T)  %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  facet_wrap(~cuestion_mig) +
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .7)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Desconfianza hacia inmigrantes, según nacionalidad de migrantes y tipo de votante',
          subtitle = 'Nada o poca confianza')
  
```

```{r ame-realista}

elsoc_long_2016_2022 %>%
  sjlabelled::as_label(ola) %>%
  filter(!is.na(r12_04), tipo_atricion == 1) %>%  
  filter(!is.na(pp_3)) %>% 
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(r12_04 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Amenaza inmigrante realista, según tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo con "Con la llegada de migrantes aumenta el desempleo"')
  
```

```{r ame-realista-proced}

elsoc_long_2016_2022 %>%
  filter(!is.na(r12_04), tipo_atricion == 1, ola %in% 4:6) %>% 
    filter(!is.na(pp_3)) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>%
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(r12_04 %in% 4:5, by = c(ola, pp_3, cuestion_mig), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  facet_wrap(~cuestion_mig) +
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Amenaza inmigrante realista, según nacionalidad de migrantes y tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo con "Con la llegada de migrantes aumenta el desempleo"')
  
```

```{r ame-simbolica}

elsoc_long_2016_2022 %>%
  sjlabelled::as_label(ola) %>%
  filter(!is.na(r12_03), tipo_atricion == 1) %>% 
  filter(!is.na(pp_3)) %>% 
      mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(r12_03 %in% 4:5, by = c(ola, pp_3), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .01, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .75)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Amenaza inmigrante simbólica, según tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo con "Con la llegada de migrantes Chile pierde su identidad"')
  
```

```{r ame-simbolica-proced}

elsoc_long_2016_2022 %>%
  filter(!is.na(r12_03), tipo_atricion == 1, ola %in% 4:6) %>% 
    filter(!is.na(pp_3)) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>%
    mutate(pp_3 = factor(pp_3,
                       labels = c("Votante Habitual", "No-votante", "Indefinido"))) %>%
  prop(r12_03 %in% 4:5, by = c(ola, pp_3, cuestion_mig), na.rm = T)  %>%
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  facet_wrap(~cuestion_mig) +
  geom_text_repel(nudge_y = .0, size = 3) +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0, .7)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Amenaza inmigrante simbólica, según nacionalidad de migrantes y tipo de votante',
          subtitle = 'De acuerdo o muy de acuerdo con "Con la llegada de migrantes Chile pierde su identidad"')
  
```

## Justificación de la violencia

```{r graf-justviolencia1-ola-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(f05_02), !is.na(f05_01), !is.na(pp_3)) %>%
  dplyr::select(f05_01, f05_02, ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(f05_01, f05_02)) %>% 
  mutate(name = factor(name,
                       levels = c('f05_01', 'f05_02'),
                       labels = c('Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto',
                                  'Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .0) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Justificación de la violencia a manos de ciudadanos, según tipo de votante',
          subtitle = 'Muchas veces o siempre se justifica' )


```

```{r graf-justviolencia2-ola-2}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  as_label(ola) %>%
  filter(!is.na(f05_03), !is.na(f05_04), !is.na(f05_07), !is.na(pp_3)) %>%
  dplyr::select(f05_03, f05_04, f05_07, ola, ponderador02, segmento_disenno, estrato_disenno, pp_3) %>% 
  pivot_longer(cols = c(f05_03, f05_04, f05_07)) %>%
  mutate(name = factor(name,
                       levels = c('f05_03', 'f05_04', 'f05_07'),
                       labels = c('Carabineros use la fuerza para\n reprimir manifestación pacífica',
                                  'Carabineros desaloje a la fuerza\na estudiantes de liceo en toma',
                                  'Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación'))) %>%
  mutate(pp_3 = factor(pp_3,
                       labels = c("Votante\nHabitual", "No-votante", "Indefinido"))) %>%
  prop(value %in% 4:5, by = c(pp_3, ola, name), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(~ name) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .8, option = 'viridis') + 
  geom_text_repel(size = 3) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Justificación de la violencia, según tipo de votante',
          subtitle = 'Muchas veces o siempre se justifica' )

```

