--- 
title: "Radiografía del Cambio Social en Chile 2016-2022"
subtitle: "Estudio Longitudinal Social de Chile"
site: bookdown::bookdown_site
documentclass: book
bibliography: ["bib/book.bib"]
csl: "bib/apa-no-ampersand.csl"
biblio-style: apalike
link-citations: yes
linkcolor: blue
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
# author: "González, Roberto; Bargsted, Matías; Figuereido, Ana; Miranda, Daniel; Cerda, Edgardo; Plaza, Alejandro; Salas-Lewin, Rocío"
description: "Resultados ELSOC 2016-2022"
github-repo: "elsoc-coes/rcs_v1"
always_allow_html: true
editor_options: 
  markdown: 
    wrap: 72
---

# author: "González, Roberto; Bargsted, Matías; Figuereido, Ana; Miranda, Daniel; Cerda, Edgardo; Plaza, Alejandro; Salas-Lewin, Rocío"

Placeholder



<!--chapter:end:index.Rmd-->


```{r setup, include=FALSE}

library(bookdown)
library(knitr)

knitr::opts_chunk$set(cache=FALSE, warning=FALSE, message=FALSE, echo=FALSE, fig.topcaption = TRUE, fig.align = 'center')
Sys.setlocale("LC_ALL","ES_ES.UTF-8")
```

```{r formats, include=FALSE }
table_format <- if (is_html_output()) {
  "html"
} else if (is_latex_output()) {
  "latex" 
}

fullw <- if (is_html_output()) {TRUE} else if (is_latex_output()) {FALSE}
fsize <- if (is_html_output()) {14} else if(is_latex_output()) {8}

ggplot2::theme_set(new = ggplot2::theme_test(base_family = "serif"))
options(knitr.kable.NA = '')

```


<!--chapter:end:01-preambulo.Rmd-->


# Presentación del estudio

Placeholder


## Sobre COES
## Sobre ELSOC
### Descripción del estudio {-}
### Acceso a Bases de Datos ELSOC {-}
### Características del diseño muestral {-}
### Características del levantamiento de datos {-}
## Atrición de la muestra
### Atrición acumulada según Sexo, Grupo etáreo, Nivel educacional y Estrato {-}
## Foco en el cambio longitudinal

<!--chapter:end:02-introduccion.Rmd-->


# Transformaciones políticas

Placeholder


## Participación electoral y proceso constituyente
## Actitudes hacia la democracia
## Identidad e involucramiento político
## Confianza institucional
## Movilización social
## Opinión pública y contingencia
## Justificación de la violencia

<!--chapter:end:03-politica.Rmd-->


# Cohesión social


```{r cargar-paquetes-4, include = FALSE}

library(knitr)
library(tidyverse)
library(sjmisc)
library(sjlabelled)
library(ggrepel)
library(ggalluvial)
library(survey)
library(elsoc)
library(lubridate)
library(viridis)
library(statar)

```


```{r cargar-datos-4, include = FALSE}

load(file.path('..', 'inputs', 'ELSOC_Long_2016_2022_v1.00_R.RData'))
load(file.path('..', 'inputs', 'ELSOC_Wide_2016_2022_v1.00_R.RData'))

# Voto en plebiscito de salida para agregar a toda la muestra:
voto_salida <- elsoc_long_2016_2022 %>% 
  filter(ola == 6) %>% 
  mutate(voto_salida = case_when(c55 == 4 ~ 5,
                                 c55 %in% 1:3 ~ c55,
                                 c55 %in% -666:-999 ~ 5,
                                 c56 %in% -666:-999 ~ 5,
                                 c56 == 2 ~ 4,
                                 c57 %in% 1:3 ~ c57,
                                 c57 %in% -666:-999 ~ 5
                          ))  %>%
  select(idencuesta, voto_salida)

# Cargar datos de perfiles:
load(file.path('..', 'inputs', 'perfiles.RData'))
perfiles0 <- perfiles

perfiles <- perfiles0 %>%
   mutate(pp_3 = factor(pp_3, 
                       levels = 1:3,
                       labels = c("Votante Habitual", "No-Votante", "Indefinido")),
          pp_4 = factor(pp_4, 
                       levels = 1:4,
                       labels = c("Votante\nCrónico (64.24%)", "Desafecto (8.30%)", "No-Votante\nCrónico (14.28%)", "Activado (13.17%)"))) %>%
   mutate(pp_5 = factor(pp_5, 
                       levels = 1:5,
                       labels = c("1 (14.27%)", "2 (11.44%)", "3 (4.73%)", 
                                  "4 (6.33%)", "5 (63.24%)")))


```


```{r}

```



## Relaciones sociales de igualdad




### Confianza interpersonal

```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rsi_confianza_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rsi_confianza_perfiles.RDS"))
```



```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rsi_altruismo_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rsi_altruismo_perfiles.RDS"))
```

### Reconocimiento y respeto de la diversidad

```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_homo_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_homo_perfiles.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_mapu_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_mapu_perfiles.RDS"))
```

```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_inmig_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_rrd_inmig_perfiles.RDS"))
```

### Lazos

```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_lazos_evolucion.RDS"))
```


```{r}
print(readRDS("../inputs/cohesion social/relaciones-sociales/graficos/gf_cs_lazos_perfiles.RDS"))
```


## Sentido de pertenencia

### Identificación con el país

### Percepción de justicia

### Confianza institucional

## Orientación al bien común

### Solidaridad

### Participación cívica

## Vínculos Territoriales

### Vínculos territoriales

#### Todos los indicadores juntos:

```{r}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1) %>%
  sjlabelled::as_label(ola) %>% 
  mutate(t02_01 = ifelse(is_nsnr(t02_01), NA, t02_01),
         t02_02 = ifelse(is_nsnr(t02_02), NA, t02_02),
         t02_03 = ifelse(is_nsnr(t02_03), NA, t02_03),
         t02_04 = ifelse(is_nsnr(t02_04), NA, t02_04)) %>% 
  rowwise() %>% 
  mutate(cohesion_barrial = sum(t02_01, t02_02, t02_03, t02_04, na.rm = TRUE) /
           sum(!is.na(t02_01), !is.na(t02_02), !is.na(t02_03), !is.na(t02_04))) %>% 
  ungroup() %>% 
  mutate(cohesion_barrial_rec = factor(cut(cohesion_barrial, breaks = c(0, 1.5, 2.5, 3.5, 4.5, 6)),
         labels = c('Totalmente\nen desacuerdo', 'En desacuerdo', 'Ni de acuerdo ni\nen desacuerdo', 'De acuerdo', 'Totalmente\nde acuerdo'))) %>% 
  prop(x = cohesion_barrial_rec, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, fill = cohesion_barrial_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85) +
  ggtitle(label = 'Grado de acuerdo con: "Este es el barrio ideal para mi", según ola') +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'white', 'black', 'black'), 5)) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top', 
        legend.title = element_blank())

```


```{r}

elsoc_long_2016_2022 %>% 
  filter(tipo_atricion == 1, ola != 5) %>%
  as_label(ola) %>% 
  mutate(t02_01 = ifelse(is_nsnr(t02_01), NA, t02_01),
         t02_02 = ifelse(is_nsnr(t02_02), NA, t02_02),
         t02_03 = ifelse(is_nsnr(t02_03), NA, t02_03),
         t02_04 = ifelse(is_nsnr(t02_04), NA, t02_04)) %>% 
  prop_list(t02_01 %in% 4:5, t02_02 %in% 4:5, t02_03 %in% 4:5, t02_04 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = glue::glue('t02_0{1:4} %in% 4:5'),
                       labels = c('Este es el barrio\nideal para mi',
                                  'Me siento integrado/a\nen este barrio',
                                  'Me identifico con la\ngente de este barrio', 
                                  'Este barrio es\nparte de mi'))) %>% 
  ggplot(aes(y = prop, x = ola, group = 1, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  facet_wrap(~name) +
  geom_text_repel(size = 3, nudge_y = .01) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Indicadores de cohesión barrial, según ola',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')
```

```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola != 5) %>%
  as_label(ola) %>% 
  mutate(t02_01 = ifelse(is_nsnr(t02_01), NA, t02_01),
         t02_02 = ifelse(is_nsnr(t02_02), NA, t02_02),
         t02_03 = ifelse(is_nsnr(t02_03), NA, t02_03),
         t02_04 = ifelse(is_nsnr(t02_04), NA, t02_04)) %>% 
  prop_list(t02_01 %in% 4:5, t02_02 %in% 4:5, t02_03 %in% 4:5, t02_04 %in% 4:5, 
            by = c(ola, pp_3), na.rm = TRUE) %>% 
  filter(!is.na(pp_3)) %>% 
  mutate(name = factor(name, 
                       levels = glue::glue('t02_0{1:4} %in% 4:5'),
                       labels = c('Este es el barrio\nideal para mi',
                                  'Me siento integrado/a\nen este barrio',
                                  'Me identifico con la\ngente de este barrio', 
                                  'Este barrio es\nparte de mi'))) %>% 
  ggplot(aes(y = prop, x = ola, group = pp_3, color = pp_3, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  facet_wrap(~name) +
  geom_text_repel(size = 3) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Indicadores de cohesión barrial, según ola',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')
```



```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola == 6) %>%
  as_label(ola) %>% 
  mutate(t02_01 = ifelse(is_nsnr(t02_01), NA, t02_01),
         t02_02 = ifelse(is_nsnr(t02_02), NA, t02_02),
         t02_03 = ifelse(is_nsnr(t02_03), NA, t02_03),
         t02_04 = ifelse(is_nsnr(t02_04), NA, t02_04)) %>% 
  prop_list(t02_01 %in% 4:5, t02_02 %in% 4:5, t02_03 %in% 4:5, t02_04 %in% 4:5, 
            by = pp_3, na.rm = TRUE) %>% 
  filter(!is.na(pp_3)) %>% 
  mutate(name = factor(name, 
                       levels = glue::glue('t02_0{1:4} %in% 4:5'),
                       labels = c('Este es el barrio\nideal para mi',
                                  'Me siento integrado/a\nen este barrio',
                                  'Me identifico con la\ngente de este barrio', 
                                  'Este barrio es\nparte de mi'))) %>% 
  ggplot(aes(y = prop, x = pp_3, fill = pp_3, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() +   
  facet_wrap(~name) +
  geom_col(position = 'dodge2') +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Indicadores de cohesión barrial (2022), según perfiles de participación',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')
```




#### Indicadores desagregados:

```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola != 5) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(t02_01 %in% 4:5, by = c(ola, pp_3), na.rm = TRUE) %>%
  filter(!is.na(pp_3)) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(size = 3) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('"Este es el barrio ideal para mi", según ola y perfiles de participación',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')

```



```{r}

elsoc_long_2016_2022 %>% 
   filter(tipo_atricion == 1, !is_nsnr(t02_02)) %>%
   mutate(t02_02 = factor(car::recode(t02_02, "1:2 = 1; 3 = 2; 4:5 = 3"),
                          levels = 1:3,
                          labels = c('Totalmente en desacuerdo\no en desacuerdo', 'Ni de acuerdo ni\nen desacuerdo', 'De acuerdo o Totalmente\nde acuerdo'))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = t02_02, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, fill = t02_02, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85) +
  ggtitle(label = 'Grado de acuerdo con: "Me siento integrado/a en este barrio", según ola') +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'black'), 5)) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top', 
        legend.title = element_blank())

```


```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola != 5) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(t02_02 %in% 4:5, by = c(ola, pp_3), na.rm = TRUE) %>%
  filter(!is.na(pp_3)) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(size = 3) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('"Me siento integrado/a en este barrio", según ola y perfiles de participación',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')

```

```{r}

elsoc_long_2016_2022 %>% 
   filter(tipo_atricion == 1, !is_nsnr(t02_03)) %>%
   mutate(t02_03 = factor(car::recode(t02_03, "1:2 = 1; 3 = 2; 4:5 = 3"),
                          levels = 1:3,
                          labels = c('Totalmente en desacuerdo\no en desacuerdo', 'Ni de acuerdo ni\nen desacuerdo', 'De acuerdo o Totalmente\nde acuerdo'))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = t02_03, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, fill = t02_03, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85) +
  ggtitle(label = 'Grado de acuerdo con: "Me identifico con la gente de este barrio", según ola') +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'black'), 5)) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top', 
        legend.title = element_blank())

```


```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola != 5) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(t02_03 %in% 4:5, by = c(ola, pp_3), na.rm = TRUE) %>%
  filter(!is.na(pp_3)) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(size = 3) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('"Me identifico con la gente de este barrio", según ola y perfiles de participación',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')

```


```{r}

elsoc_long_2016_2022 %>% 
   filter(tipo_atricion == 1, !is_nsnr(t02_04)) %>%
   mutate(t02_04 = factor(car::recode(t02_04, "1:2 = 1; 3 = 2; 4:5 = 3"),
                          levels = 1:3,
                          labels = c('Totalmente en desacuerdo\no en desacuerdo', 'Ni de acuerdo ni\nen desacuerdo', 'De acuerdo o Totalmente\nde acuerdo'))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = t02_04, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, fill = t02_04, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85) +
  ggtitle(label = 'Grado de acuerdo con: "Este barrio se parte de mi", según ola') +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'black'), 5)) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top', 
        legend.title = element_blank())

```


```{r}

elsoc_long_2016_2022 %>% 
  left_join(perfiles, by = 'idencuesta') %>% 
  filter(tipo_atricion == 1, ola != 5) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(t02_04 %in% 4:5, by = c(ola, pp_3), na.rm = TRUE) %>%
  filter(!is.na(pp_3)) %>% 
  ggplot(aes(y = prop, x = ola, color = pp_3, group = pp_3,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(size = 3) +
  geom_point(size = 1.8) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .8, option = 'viridis') +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('"Este barrio se parte de mi", según ola y perfiles de participación',
          subtitle = 'Porcentaje que responde De acuerdo o Totalmente de acuerdo')

```

<!--chapter:end:04-cohesion-social.Rmd-->

